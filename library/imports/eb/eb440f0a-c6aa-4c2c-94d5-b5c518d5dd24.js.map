{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\VideoSimple\\js\\video/assets\\VideoSimple\\js\\video\\VideoShader.js"],"names":["module","exports","node","_currentBuffer","default_vert","gray_frag","MycreateTexture","gl","cc","_renderContext","texture","createTexture","bindTexture","TEXTURE_2D","texParameteri","TEXTURE_MAG_FILTER","LINEAR","TEXTURE_MIN_FILTER","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","ShaderEffect","program","GLProgram","sys","isNative","initWithString","link","updateUniforms","initWithVertexShaderByteArray","addAttribute","macro","ATTRIBUTE_NAME_POSITION","VERTEX_ATTRIB_POSITION","ATTRIBUTE_NAME_COLOR","VERTEX_ATTRIB_COLOR","ATTRIBUTE_NAME_TEX_COORD","VERTEX_ATTRIB_TEX_COORDS","_uniforms","getUniformLocation","_programObj","setUniformLocationWith1i","isAllChildrenUse","setProgram","_sgNode","getComponent","Sprite","_texture1","_texture2","_texture3","Myrendering","size","videoSize","lumaSize","width","height","chromaSize","buffer","uint8Y","subarray","uint8Cr","uint8Cb","activeTexture","TEXTURE0","texImage2D","LUMINANCE","UNSIGNED_BYTE","TEXTURE1","TEXTURE2","glProgram_state","GLProgramState","getOrCreateWithGLProgram","setGLProgramState","setShaderProgram","children","i","length"],"mappings":"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","file":"VideoShader.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\VideoSimple\\js\\video","sourcesContent":["module.exports = {\r\n    node: null,\r\n    _currentBuffer: null,\r\n    default_vert: `\r\n    attribute vec4 a_position;\r\n    attribute vec2 a_texCoord;\r\n    attribute vec4 a_color;\r\n    varying vec2 v_texCoord;\r\n    varying lowp vec4 v_fragmentColor;\r\n    void main()\r\n    {\r\n        gl_Position = CC_PMatrix * a_position;\r\n        v_fragmentColor = a_color;\r\n        v_texCoord = a_texCoord;\r\n    }\r\n    `,\r\n    gray_frag: `\r\n    #ifdef GL_ES\r\n    precision mediump float;\r\n    #endif\r\n    varying vec4 v_fragmentColor;\r\n    varying vec2 v_texCoord;\r\n\r\n    uniform sampler2D YTexture;\r\n    uniform sampler2D CBTexture;\r\n    uniform sampler2D CRTexture;\r\n\r\n    \r\n    const mat4 YUV2RGB = mat4(1.1643828125, 0, 1.59602734375, -.87078515625,\r\n           1.1643828125, -.39176171875, -.81296875, .52959375,\r\n           1.1643828125, 2.017234375, 0, -1.081390625,\r\n           0, 0, 0, 1);\r\n    const mat4 YUV2RGB2 = mat4(1.000000,    1.000000,    1.000000,    0.000000,\r\n        0.000000,    -0.34414,    1.177200,    0.000000,\r\n        1.402000,    -0.71414,    0.000000,    0.000000,\r\n        0.000000,    0.000000,    0.000000,    1.000000);\r\n    \r\n    void main()\r\n    {\r\n        \r\n\r\n        float y = texture2D(YTexture, v_texCoord).r;\r\n        float cr = texture2D(CBTexture, v_texCoord).r;\r\n        float cb = texture2D(CRTexture, v_texCoord).r;\r\n        gl_FragColor = v_fragmentColor * vec4(y, cr, cb, 1.0) *YUV2RGB ;\r\n    }\r\n    `,\r\n    MycreateTexture: function () {\r\n        const gl = cc._renderContext;\r\n        const texture = gl.createTexture();\r\n        gl.bindTexture(gl.TEXTURE_2D, texture);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR); //gl.LINEAR\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n\r\n        return texture;\r\n    },\r\n    /**\r\n     * shader\r\n     */\r\n    ShaderEffect: function () {\r\n        this.program = new cc.GLProgram();\r\n        if (cc.sys.isNative) {\r\n            this.program.initWithString(this.default_vert, this.gray_frag);\r\n            this.program.link();\r\n            this.program.updateUniforms();\r\n        } else {\r\n            this.program.initWithVertexShaderByteArray(this.default_vert, this.gray_frag);\r\n            this.program.addAttribute(cc.macro.ATTRIBUTE_NAME_POSITION, cc.macro.VERTEX_ATTRIB_POSITION);\r\n            this.program.addAttribute(cc.macro.ATTRIBUTE_NAME_COLOR, cc.macro.VERTEX_ATTRIB_COLOR);\r\n            this.program.addAttribute(cc.macro.ATTRIBUTE_NAME_TEX_COORD, cc.macro.VERTEX_ATTRIB_TEX_COORDS);\r\n            this.program.link();\r\n            this.program.updateUniforms();\r\n        }\r\n        let gl = cc._renderContext;\r\n        this.program._uniforms[1] = gl.getUniformLocation(this.program._programObj, \"YTexture\");\r\n        this.program._uniforms[2] = gl.getUniformLocation(this.program._programObj, \"CBTexture\");\r\n        this.program._uniforms[3] = gl.getUniformLocation(this.program._programObj, \"CRTexture\");\r\n\r\n        this.program.setUniformLocationWith1i(this.program._uniforms[1], 0);\r\n        this.program.setUniformLocationWith1i(this.program._uniforms[2], 1);\r\n        this.program.setUniformLocationWith1i(this.program._uniforms[3], 2);\r\n        if (this.isAllChildrenUse) {\r\n            this.setProgram(this.node._sgNode, this.program);\r\n        } else {\r\n            this.setProgram(this.node.getComponent(cc.Sprite)._sgNode, this.program);\r\n        }\r\n        this._texture1 = this.MycreateTexture();\r\n        this._texture2 = this.MycreateTexture();\r\n        this._texture3 = this.MycreateTexture();\r\n    },\r\n    Myrendering: function (size) {\r\n        var videoSize = size; //{width:864,height:480};\r\n        const lumaSize = videoSize.width * videoSize.height;\r\n        const chromaSize = lumaSize >> 2;\r\n        const buffer = this._currentBuffer;\r\n        if (buffer) {\r\n            var uint8Y = buffer.subarray(0, lumaSize),\r\n                uint8Cr = buffer.subarray(lumaSize, lumaSize + chromaSize),\r\n                uint8Cb = buffer.subarray(lumaSize + chromaSize, lumaSize + 2 *\r\n                    chromaSize);\r\n            gl.activeTexture(gl.TEXTURE0);\r\n            gl.bindTexture(gl.TEXTURE_2D, this._texture1);\r\n            gl.texImage2D(gl.TEXTURE_2D, 0, gl.LUMINANCE, videoSize.width >> 1,\r\n                videoSize.height >> 1, 0, gl.LUMINANCE, gl.UNSIGNED_BYTE, uint8Y);\r\n            gl.activeTexture(gl.TEXTURE1);\r\n            gl.bindTexture(gl.TEXTURE_2D, this._texture2);\r\n            gl.texImage2D(gl.TEXTURE_2D, 0, gl.LUMINANCE, videoSize.width >> 1,\r\n                videoSize.height >> 1, 0, gl.LUMINANCE, gl.UNSIGNED_BYTE, uint8Cr);\r\n            gl.activeTexture(gl.TEXTURE2);\r\n            gl.bindTexture(gl.TEXTURE_2D, this._texture3);\r\n            gl.texImage2D(gl.TEXTURE_2D, 0, gl.LUMINANCE, videoSize.width >> 1,\r\n                videoSize.height >> 1, 0, gl.LUMINANCE, gl.UNSIGNED_BYTE, uint8Cb);\r\n            uint8Y = null;\r\n            uint8Cr = null;\r\n            uint8Cb = null;\r\n        }\r\n    },\r\n    setProgram: function (node, program) {\r\n        if (cc.sys.isNative) {\r\n            var glProgram_state = cc.GLProgramState.getOrCreateWithGLProgram(program);\r\n            node.setGLProgramState(glProgram_state);\r\n        } else {\r\n            node.setShaderProgram(program);\r\n        }\r\n        var children = node.children;\r\n        if (!children)\r\n            return;\r\n\r\n        for (var i = 0; i < children.length; i++) {\r\n            this.setProgram(children[i], program);\r\n        }\r\n    },\r\n}"]}